name: Secret Management Demo

on:
  workflow_dispatch:  # Manual trigger only - safe for testing
  push:
    branches:
      - main
    paths:
      - '.github/workflows/secret-demo.yml'

jobs:
  demonstrate-secret-usage:
    name: Secure Secret Handling
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      
      # ‚úÖ GOOD: Secrets are automatically masked in logs
      - name: Use secret securely (masked in logs)
        env:
          API_TOKEN: ${{ secrets.API_TOKEN }}
        run: |
          echo "‚úÖ Secret is available in environment"
          echo "‚úÖ Token length: ${#API_TOKEN} characters"
          echo "‚úÖ Attempting to echo secret (will be masked):"
          echo "Token: $API_TOKEN"
          echo ""
          echo "‚ö†Ô∏è  Notice: GitHub automatically masks the actual value!"
      
      # ‚úÖ GOOD: Use secrets in commands without exposing them
      - name: Simulate API call with secret
        env:
          API_TOKEN: ${{ secrets.API_TOKEN }}
          DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
        run: |
          echo "üîê Simulating secure API authentication..."
          # In real scenario: curl -H "Authorization: Bearer $API_TOKEN" https://api.example.com
          echo "‚úÖ API call completed (secret was used but not exposed)"
          
          echo ""
          echo "üîê Simulating database connection..."
          # In real scenario: psql -U user -h host -c "SELECT 1"
          echo "‚úÖ Database connection successful (password was used but not logged)"
      
      # ‚ö†Ô∏è  DEMONSTRATION: What NOT to do
      - name: Security Anti-Patterns (DO NOT DO THIS)
        run: |
          echo "‚ùå ANTI-PATTERN EXAMPLES (educational purposes):"
          echo ""
          echo "1. ‚ùå Never write secrets to files without encryption:"
          echo "   echo \$API_TOKEN > token.txt  # BAD!"
          echo ""
          echo "2. ‚ùå Never pass secrets as command-line arguments (visible in process list):"
          echo "   ./deploy.sh --api-key=\$API_TOKEN  # BAD!"
          echo ""
          echo "3. ‚ùå Never commit secrets to the repository"
          echo "   git add config.yml  # if it contains secrets - BAD!"
          echo ""
          echo "4. ‚ùå Never use secrets in pull_request triggers from forks"
          echo "   Forks don't have access to secrets (security feature)"
      
      # ‚úÖ GOOD: Demonstrate secret availability check
      - name: Verify secrets are available
        run: |
          echo "üîç Checking secret availability..."
          
          if [ -z "${{ secrets.API_TOKEN }}" ]; then
            echo "‚ùå ERROR: API_TOKEN secret is not configured"
            exit 1
          else
            echo "‚úÖ API_TOKEN is configured"
          fi
          
          if [ -z "${{ secrets.DATABASE_PASSWORD }}" ]; then
            echo "‚ùå ERROR: DATABASE_PASSWORD secret is not configured"
            exit 1
          else
            echo "‚úÖ DATABASE_PASSWORD is configured"
          fi
          
          if [ -z "${{ secrets.DEPLOY_KEY }}" ]; then
            echo "‚ùå ERROR: DEPLOY_KEY secret is not configured"
            exit 1
          else
            echo "‚úÖ DEPLOY_KEY is configured"
          fi
          
          echo ""
          echo "‚úÖ All required secrets are properly configured!"

  demonstrate-secret-masking:
    name: Secret Masking Demonstration
    runs-on: ubuntu-latest
    
    steps:
      - name: Show secret masking in action
        env:
          DEMO_SECRET: ${{ secrets.API_TOKEN }}
        run: |
          echo "üé≠ Demonstrating GitHub's automatic secret masking..."
          echo ""
          
          # Try to print the secret in various ways - all will be masked
          echo "Attempt 1 - Direct echo:"
          echo "$DEMO_SECRET"
          
          echo ""
          echo "Attempt 2 - Variable substitution:"
          echo "Secret value: $DEMO_SECRET"
          
          echo ""
          echo "Attempt 3 - In a sentence:"
          echo "The secret is: $DEMO_SECRET and it should be masked"
          
          echo ""
          echo "‚úÖ All attempts above show *** instead of actual secret!"
          echo "‚úÖ This is GitHub's automatic secret protection in action"

  environment-based-secrets:
    name: Environment-Specific Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Explain environment-based secret strategy
        run: |
          echo "üåç Environment-Based Secret Management Strategy"
          echo ""
          echo "For production deployments, use GitHub Environments:"
          echo ""
          echo "1. Create environments: Settings ‚Üí Environments"
          echo "   - staging"
          echo "   - production"
          echo ""
          echo "2. Add environment-specific secrets:"
          echo "   - staging: API_TOKEN_STAGING"
          echo "   - production: API_TOKEN_PRODUCTION"
          echo ""
          echo "3. Add protection rules:"
          echo "   - Require reviewers for production"
          echo "   - Deployment branches (only main)"
          echo ""
          echo "4. Use in workflow:"
          echo "   environment: production"
          echo "   This gives access to production secrets only"
          echo ""
          echo "‚úÖ This ensures staging secrets can't access production!"

  secret-rotation-reminder:
    name: Secret Rotation Policy
    runs-on: ubuntu-latest
    
    steps:
      - name: Display secret rotation policy
        run: |
          echo "üîÑ Secret Rotation Policy"
          echo ""
          echo "All secrets should be rotated according to schedule:"
          echo ""
          echo "üìÖ Rotation Schedule:"
          echo "  - API Tokens: Every 90 days"
          echo "  - Database Passwords: Every 90 days"
          echo "  - SSH Keys: Every 180 days"
          echo "  - Service Account Keys: Every 60 days"
          echo ""
          echo "‚ö†Ô∏è  Immediate rotation required if:"
          echo "  - Secret scanning detects a leak"
          echo "  - Team member with access leaves"
          echo "  - Suspected compromise"
          echo "  - After security incident"
          echo ""
          echo "üìã Rotation Process:"
          echo "  1. Generate new secret"
          echo "  2. Update in GitHub Secrets"
          echo "  3. Deploy applications with new secret"
          echo "  4. Verify functionality"
          echo "  5. Revoke old secret"
          echo "  6. Document rotation in audit log"
