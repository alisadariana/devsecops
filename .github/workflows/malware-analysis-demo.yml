name: Advanced Malware Analysis Demo

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'malware-demo/**'
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Type of analysis to perform'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - static-only
          - dynamic-only

jobs:
  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.analysis_type != 'dynamic-only' || github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install analysis tools
        run: |
          pip install bandit safety semgrep flake8 pylint

      - name: Run Bandit (Python security linter)
        run: |
          echo "üîç Running Bandit security analysis..."
          bandit -r malware-demo/ -f json -o bandit-report.json || true
          echo "Bandit analysis complete"

      - name: Run Safety (dependency vulnerability check)
        run: |
          echo "üîç Checking for vulnerable dependencies..."
          safety check --json > safety-report.json || true
          echo "Safety check complete"

      - name: Run Semgrep (semantic code analysis)
        run: |
          echo "üîç Running Semgrep security analysis..."
          semgrep --config auto --json > semgrep-report.json || true
          echo "Semgrep analysis complete"

      - name: Generate static analysis report
        run: |
          echo "üìä Generating static analysis report..."
          cat > static-analysis-report.md << 'EOF'
          # Static Code Analysis Report

          **Analysis Date:** $(date)
          **Repository:** ${{ github.repository }}
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}

          ## Security Findings

          ### Bandit Results
          ```json
          $(cat bandit-report.json 2>/dev/null || echo "No Bandit results available")
          ```

          ### Safety Check Results
          ```json
          $(cat safety-report.json 2>/dev/null || echo "No Safety results available")
          ```

          ### Semgrep Results
          ```json
          $(cat semgrep-report.json 2>/dev/null || echo "No Semgrep results available")
          ```

          ## Recommendations

          - Review all high-severity findings immediately
          - Update vulnerable dependencies
          - Implement secure coding practices
          - Consider using virtual environments for isolation

          ---
          *Generated by Advanced DevSecOps Malware Analysis Demo*
          EOF

      - name: Upload static analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: static-analysis-results
          path: |
            *-report.json
            static-analysis-report.md

  dynamic-analysis:
    name: Dynamic Analysis in Docker Sandbox
    runs-on: ubuntu-latest
    if: github.event.inputs.analysis_type != 'static-only' || github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build malware analyzer image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.analyzer
          push: false
          tags: malware-analyzer:latest
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Run analysis in secure sandbox
        run: |
          echo "üî¨ Running advanced malware analysis in secure Docker sandbox..."

          # Find Python files in malware-demo directory
          MALWARE_FILES=$(find malware-demo -name "*.py" -type f 2>/dev/null || echo "")

          if [ -z "$MALWARE_FILES" ]; then
            echo "No Python files found in malware-demo directory"
            exit 0
          fi

          # Create analysis directory
          mkdir -p analysis-results

          # Run analysis for each file in isolated container
          for file in $MALWARE_FILES; do
            echo "üîç Analyzing $file in sandbox..."

            # Run analysis in container with strict security restrictions
            docker run --rm \
              --memory=512m \
              --cpus=0.5 \
              --read-only \
              --tmpfs /tmp \
              --network none \
              -v $(pwd):/workspace:ro \
              -w /workspace \
              --user $(id -u):$(id -g) \
              malware-analyzer:latest \
              python3 analyze-malware.py "$file"

            # Move results to analysis directory
            if [ -f "$(basename "$file" .py).analysis.json" ]; then
              mv "$(basename "$file" .py).analysis.json" analysis-results/
            fi
          done

          echo "‚úÖ Sandbox analysis complete"

      - name: Generate dynamic analysis report
        run: |
          echo "üìä Generating comprehensive dynamic analysis report..."
          cat > dynamic-analysis-report.md << 'EOF'
          # Advanced Dynamic Malware Analysis Report

          **Analysis Date:** $(date)
          **Repository:** ${{ github.repository }}
          **Commit:** ${{ github.sha }}
          **Environment:** Docker Sandbox with Security Restrictions

          ## Analysis Environment

          - **Container**: Python 3.11 with security analysis tools
          - **Memory Limit**: 512MB
          - **CPU Limit**: 0.5 cores
          - **Network**: Disabled (no outbound connections)
          - **Filesystem**: Read-only with isolated /tmp
          - **User**: Non-root (analyzer user)
          - **Security**: YARA rules, behavioral analysis, risk scoring

          ## Files Analyzed
          EOF

          # List analyzed files
          if [ -d "analysis-results" ]; then
            for json_file in analysis-results/*.analysis.json; do
              if [ -f "$json_file" ]; then
                echo "- $(basename "$json_file" .analysis.json)" >> dynamic-analysis-report.md
              fi
            done
          fi

          cat >> dynamic-analysis-report.md << 'EOF'

          ## Detailed Analysis Results
          EOF

          # Include detailed results
          if [ -d "analysis-results" ]; then
            for json_file in analysis-results/*.analysis.json; do
              if [ -f "$json_file" ]; then
                filename=$(basename "$json_file" .analysis.json)
                echo "### Analysis: $filename" >> dynamic-analysis-report.md
                echo "" >> dynamic-analysis-report.md

                # Extract key information from JSON
                risk_score=$(jq -r '.risk_assessment.total_score // 0' "$json_file" 2>/dev/null || echo "0")
                risk_level=$(jq -r '.risk_assessment.risk_level // "Unknown"' "$json_file" 2>/dev/null || echo "Unknown")

                echo "**Risk Score:** $risk_score/100" >> dynamic-analysis-report.md
                echo "**Risk Level:** $risk_level" >> dynamic-analysis-report.md
                echo "" >> dynamic-analysis-report.md

                # Show suspicious imports
                suspicious_imports=$(jq -r '.static_analysis.suspicious_imports // [] | length' "$json_file" 2>/dev/null || echo "0")
                if [ "$suspicious_imports" -gt 0 ]; then
                  echo "**Suspicious Imports Found:** $suspicious_imports" >> dynamic-analysis-report.md
                  jq -r '.static_analysis.suspicious_imports[]?.module // empty' "$json_file" 2>/dev/null | sed 's/^/- /' >> dynamic-analysis-report.md
                  echo "" >> dynamic-analysis-report.md
                fi

                # Show dangerous functions
                dangerous_functions=$(jq -r '.static_analysis.dangerous_functions // [] | length' "$json_file" 2>/dev/null || echo "0")
                if [ "$dangerous_functions" -gt 0 ]; then
                  echo "**Dangerous Functions Found:** $dangerous_functions" >> dynamic-analysis-report.md
                  jq -r '.static_analysis.dangerous_functions[] // empty' "$json_file" 2>/dev/null | sed 's/^/- /' >> dynamic-analysis-report.md
                  echo "" >> dynamic-analysis-report.md
                fi

                # Show hardcoded secrets
                secrets=$(jq -r '.static_analysis.hardcoded_secrets // [] | length' "$json_file" 2>/dev/null || echo "0")
                if [ "$secrets" -gt 0 ]; then
                  echo "**Potential Hardcoded Secrets:** $secrets" >> dynamic-analysis-report.md
                  echo "" >> dynamic-analysis-report.md
                fi

                # Show recommendations
                echo "**Security Recommendations:**" >> dynamic-analysis-report.md
                jq -r '.recommendations[] // empty' "$json_file" 2>/dev/null | sed 's/^/- /' >> dynamic-analysis-report.md
                echo "" >> dynamic-analysis-report.md
              fi
            done
          fi

          cat >> dynamic-analysis-report.md << 'EOF'
          ## Security Assessment Summary

          ### Risk Levels
          - **High Risk (70-100)**: Immediate attention required - potential malware
          - **Medium Risk (40-69)**: Review recommended - suspicious patterns detected
          - **Low Risk (0-39)**: Generally safe - minimal security concerns

          ### Analysis Capabilities
          - ‚úÖ Static code analysis (imports, functions, patterns)
          - ‚úÖ Behavioral pattern detection
          - ‚úÖ Risk scoring algorithm
          - ‚úÖ YARA rule matching
          - ‚úÖ File and network activity simulation
          - ‚ùå Dynamic execution (disabled for safety)

          ## Sandbox Security Features

          - **Resource Limits**: Memory and CPU restrictions prevent DoS
          - **Network Isolation**: No outbound connections allowed
          - **Filesystem Protection**: Read-only access prevents modification
          - **User Isolation**: Non-root execution for privilege separation
          - **Temporary Storage**: Isolated /tmp directory

          ## Recommendations

          - Never execute unknown code outside sandboxed environments
          - Implement network isolation for suspicious code
          - Use resource limits and monitoring for all code execution
          - Log all system calls and network activity
          - Consider using dedicated malware analysis platforms for production
          - Implement human oversight for high-risk code

          ---
          *Generated by Advanced DevSecOps Malware Analysis Demo*
          EOF

      - name: Upload dynamic analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dynamic-analysis-results
          path: |
            analysis-results/*.analysis.json
            dynamic-analysis-report.md

  generate-final-report:
    name: Generate Comprehensive Security Report
    runs-on: ubuntu-latest
    needs: [static-analysis, dynamic-analysis]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download static analysis results
        uses: actions/download-artifact@v4
        with:
          name: static-analysis-results

      - name: Download dynamic analysis results
        uses: actions/download-artifact@v4
        with:
          name: dynamic-analysis-results

      - name: Generate comprehensive report
        run: |
          echo "üìã Generating comprehensive security report..."
          cat > MALWARE-ANALYSIS-REPORT.md << 'EOF'
          # üîí Advanced DevSecOps Malware Analysis Report

          **Analysis Date:** $(date)
          **Repository:** ${{ github.repository }}
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Triggered by:** ${{ github.event_name }}

          ---

          ## Executive Summary

          This report contains the results of advanced automated malware analysis performed on code pushed to the repository. The analysis includes both static and dynamic examination of suspicious code in a secure Docker sandbox environment with comprehensive security restrictions.

          ## Analysis Methodology

          ### Static Analysis
          - **Bandit**: Python security linting with comprehensive rule set
          - **Safety**: Dependency vulnerability scanning
          - **Semgrep**: Semantic code analysis with custom rules
          - **Custom Analysis**: Advanced pattern matching and risk scoring

          ### Dynamic Analysis
          - Sandboxed execution in Docker container with security restrictions
          - Memory and CPU limits to prevent resource exhaustion
          - Network isolation to prevent external communications
          - Read-only filesystem with isolated temporary storage
          - Non-root user execution for privilege separation
          - YARA rule-based malware detection

          ### Security Measures
          - Container resource limits (512MB RAM, 0.5 CPU cores)
          - Network disabled to prevent outbound connections
          - Read-only root filesystem with isolated /tmp
          - Non-privileged user execution
          - Comprehensive behavioral analysis

          ---

          EOF

          # Include static analysis results
          if [ -f "static-analysis-report.md" ]; then
            echo "## Static Analysis Results" >> MALWARE-ANALYSIS-REPORT.md
            echo "" >> MALWARE-ANALYSIS-REPORT.md
            cat static-analysis-report.md >> MALWARE-ANALYSIS-REPORT.md
            echo "" >> MALWARE-ANALYSIS-REPORT.md
            echo "---" >> MALWARE-ANALYSIS-REPORT.md
            echo "" >> MALWARE-ANALYSIS-REPORT.md
          fi

          # Include dynamic analysis results
          if [ -f "dynamic-analysis-report.md" ]; then
            echo "## Dynamic Analysis Results" >> MALWARE-ANALYSIS-REPORT.md
            echo "" >> MALWARE-ANALYSIS-REPORT.md
            cat dynamic-analysis-report.md >> MALWARE-ANALYSIS-REPORT.md
            echo "" >> MALWARE-ANALYSIS-REPORT.md
          fi

          # Add risk summary
          echo "## Risk Summary" >> MALWARE-ANALYSIS-REPORT.md
          echo "" >> MALWARE-ANALYSIS-REPORT.md

          if [ -d "analysis-results" ]; then
            high_risk=0
            medium_risk=0
            low_risk=0
            total_files=0

            for json_file in analysis-results/*.analysis.json; do
              if [ -f "$json_file" ]; then
                ((total_files++))
                risk_score=$(jq -r '.risk_assessment.total_score // 0' "$json_file" 2>/dev/null || echo "0")
                if [ "$risk_score" -ge 70 ]; then
                  ((high_risk++))
                elif [ "$risk_score" -ge 40 ]; then
                  ((medium_risk++))
                else
                  ((low_risk++))
                fi
              fi
            done

            echo "### Risk Distribution ($total_files files analyzed)" >> MALWARE-ANALYSIS-REPORT.md
            echo "- **High Risk Files:** $high_risk üî¥" >> MALWARE-ANALYSIS-REPORT.md
            echo "- **Medium Risk Files:** $medium_risk üü°" >> MALWARE-ANALYSIS-REPORT.md
            echo "- **Low Risk Files:** $low_risk üü¢" >> MALWARE-ANALYSIS-REPORT.md
            echo "" >> MALWARE-ANALYSIS-REPORT.md

            if [ "$high_risk" -gt 0 ]; then
              echo "**‚ö†Ô∏è ALERT:** High-risk files detected! Immediate security review required." >> MALWARE-ANALYSIS-REPORT.md
              echo "" >> MALWARE-ANALYSIS-REPORT.md
            fi
          fi

          cat >> MALWARE-ANALYSIS-REPORT.md << 'EOF'
          ## Security Recommendations

          ### Immediate Actions
          - Review all high-risk findings immediately
          - Update vulnerable dependencies
          - Implement additional access controls
          - Consider code signing for trusted sources

          ### Preventive Measures
          - Use pre-commit hooks for code scanning
          - Implement CI/CD security gates
          - Regular security training for developers
          - Automated dependency updates
          - Multi-factor authentication for repository access

          ### Best Practices
          - Never commit sensitive credentials
          - Use environment variables for secrets
          - Implement least privilege access
          - Regular security audits and penetration testing
          - Code review requirements for security-critical changes
          - Implement branch protection rules

          ## Demo Information

          This is a demonstration of advanced automated malware analysis in a DevSecOps pipeline. In production environments:

          - Use dedicated malware analysis platforms (e.g., Cuckoo Sandbox, Joe Sandbox)
          - Implement more sophisticated sandboxing with system call interception
          - Add human oversight for critical findings
          - Integrate with SIEM and incident response systems
          - Consider using hardware-assisted virtualization for better isolation
          - Implement real-time alerting for high-risk detections

          ## Analysis Tools Used

          - **Bandit**: Python security linting
          - **Safety**: Dependency vulnerability checking
          - **Semgrep**: Semantic code analysis
          - **Custom Analyzer**: Advanced behavioral analysis with risk scoring
          - **YARA**: Pattern-based malware detection
          - **Docker**: Containerized sandbox execution with security restrictions
          - **JQ**: JSON processing for report generation

          ---

          ## Contact Information

          For security concerns or questions about this analysis:
          - Repository: ${{ github.repository }}
          - Security Team: alisadariana@protonmail.com
          - Report ID: ${{ github.run_id }}

          ---
          *Report generated by Advanced DevSecOps Malware Analysis Demo*
          *For educational and demonstration purposes only*
          EOF

      - name: Upload final report
        uses: actions/upload-artifact@v4
        with:
          name: malware-analysis-report
          path: MALWARE-ANALYSIS-REPORT.md

      - name: Comment on PR (if applicable)
        if: github.event_name == 'push' && github.event.pull_request
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('MALWARE-ANALYSIS-REPORT.md', 'utf8');

            // Extract key findings
            const highRiskMatch = report.match(/- \*\*High Risk Files:\*\* (\d+)/);
            const highRiskCount = highRiskMatch ? parseInt(highRiskMatch[1]) : 0;

            let summary = `## üîí Advanced Malware Analysis Complete\n\n`;
            summary += `**Analysis completed for ${report.match(/Risk Distribution \((\d+) files analyzed\)/)?.[1] || 0} files**\n\n`;

            if (highRiskCount > 0) {
              summary += `üö® **${highRiskCount} HIGH-RISK files detected!**\n\n`;
              summary += `‚ö†Ô∏è **Security Review Required Immediately**\n\n`;
            } else {
              summary += `‚úÖ **No high-risk files detected**\n\n`;
            }

            summary += `üìã [View Full Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });