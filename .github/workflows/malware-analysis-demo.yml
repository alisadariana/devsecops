name: Advanced Malware Analysis Demo

on:
  pull_request:
    branches: [ feature/malware-analysis-demo ]
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Type of analysis to perform'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - static-only
          - dynamic-only

jobs:
  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.analysis_type != 'dynamic-only' || github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install analysis tools
        run: |
          pip install bandit safety semgrep flake8 pylint

      - name: Run Bandit (Python security linter)
        run: |
          echo "ðŸ” Running Bandit security analysis..."
          bandit -r malware-demo/ -f json -o bandit-report.json || true
          echo "Bandit analysis complete"

      - name: Run Safety (dependency vulnerability check)
        run: |
          echo "ðŸ” Checking for vulnerable dependencies..."
          safety check --json > safety-report.json || true
          echo "Safety check complete"

      - name: Run Semgrep (semantic code analysis)
        run: |
          echo "ðŸ” Running Semgrep security analysis..."
          semgrep --config auto --json > semgrep-report.json || true
          echo "Semgrep analysis complete"

      - name: Generate static analysis report
        run: |
          echo "ðŸ“Š Generating static analysis report..."
          cat > static-analysis-report.md << 'EOF'
          # Static Code Analysis Report

          **Analysis Date:** $(date)
          **Repository:** ${{ github.repository }}
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}

          ## Security Findings

          ### Bandit Results
          ```json
          $(cat bandit-report.json 2>/dev/null || echo "No Bandit results available")
          ```

          ### Safety Check Results
          ```json
          $(cat safety-report.json 2>/dev/null || echo "No Safety results available")
          ```

          ### Semgrep Results
          ```json
          $(cat semgrep-report.json 2>/dev/null || echo "No Semgrep results available")
          ```

          ## Recommendations

          - Review all high-severity findings immediately
          - Update vulnerable dependencies
          - Implement secure coding practices
          - Consider using virtual environments for isolation

          ---
          *Generated by Advanced DevSecOps Malware Analysis Demo*
          EOF

      - name: Upload static analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: static-analysis-results
          path: |
            *-report.json
            static-analysis-report.md