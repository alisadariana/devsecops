name: Secret Leak Detection

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop

jobs:
  scan-for-secrets:
    name: Scan for Leaked Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0  # Full history for comprehensive scan
      
      - name: Check for common secret patterns
        run: |
          echo "üîç Scanning for common secret patterns..."
          
          # Define patterns to search for
          PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "api[_-]?key\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
            "token\s*=\s*['\"][^'\"]+['\"]"
            "aws_access_key_id"
            "aws_secret_access_key"
            "AKIA[0-9A-Z]{16}"
            "-----BEGIN RSA PRIVATE KEY-----"
            "-----BEGIN OPENSSH PRIVATE KEY-----"
          )
          
          FOUND_ISSUES=0
          
          for pattern in "${PATTERNS[@]}"; do
            echo "Checking pattern: $pattern"
            
            # Search in tracked files only (ignore .git directory)
            if git grep -niE "$pattern" -- ':!.git' ':!*.md' ':!.github/workflows/secret-scan.yml' 2>/dev/null; then
              echo "‚ùå Found potential secret matching pattern: $pattern"
              FOUND_ISSUES=1
            fi
          done
          
          if [ $FOUND_ISSUES -eq 1 ]; then
            echo ""
            echo "‚ùå SECURITY WARNING: Potential secrets detected in code!"
            echo "Please review the findings above and remove any sensitive data."
            echo ""
            echo "If these are false positives:"
            echo "  1. Add the file to .gitignore if it's test data"
            echo "  2. Use environment variables for real secrets"
            echo "  3. Store secrets in GitHub Secrets (Settings ‚Üí Secrets)"
            exit 1
          else
            echo "‚úÖ No obvious secret patterns detected"
          fi
      
      - name: Check for hardcoded IPs and URLs
        run: |
          echo ""
          echo "üåê Checking for hardcoded sensitive URLs and IPs..."
          
          # Look for hardcoded production URLs (adjust patterns as needed)
          if git grep -niE "(http|https)://[a-zA-Z0-9.-]+(prod|production|api)" -- ':!.git' ':!*.md' 2>/dev/null; then
            echo "‚ö†Ô∏è  WARNING: Found hardcoded production URLs"
            echo "Consider using environment variables for environment-specific URLs"
          else
            echo "‚úÖ No hardcoded production URLs found"
          fi
      
      - name: Check for environment files
        run: |
          echo ""
          echo "üìÅ Checking for accidentally committed environment files..."
          
          # Check if any .env files are tracked (should be in .gitignore)
          ENV_FILES=$(git ls-files | grep -E "\\.env$|\\.env\\..*$" || true)
          
          if [ -n "$ENV_FILES" ]; then
            echo "‚ùå ERROR: Environment files found in repository:"
            echo "$ENV_FILES"
            echo ""
            echo "These files should be in .gitignore:"
            echo "  .env"
            echo "  .env.local"
            echo "  .env.*.local"
            exit 1
          else
            echo "‚úÖ No environment files committed"
          fi
      
      - name: Security scan summary
        run: |
          echo ""
          echo "==========================================="
          echo "‚úÖ Secret Leak Detection Complete"
          echo "==========================================="
          echo ""
          echo "Additional Security Reminders:"
          echo "  - GitHub secret scanning is enabled"
          echo "  - Push protection prevents secret commits"
          echo "  - Always use GitHub Secrets for sensitive data"
          echo "  - Rotate secrets every 90 days"
          echo "  - Never commit .env files or private keys"
          echo ""
          echo "To use secrets in workflows:"
          echo '  Use: secrets.SECRET_NAME or ${{ secrets.SECRET_NAME }}'
