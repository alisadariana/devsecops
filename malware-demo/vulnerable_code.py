#!/usr/bin/env python3
"""
Vulnerable Example Code - For Security Analysis Demo
This script intentionally contains security vulnerabilities to demonstrate
how static analyzers detect security issues
"""

import subprocess
import pickle
import sqlite3
import os
from flask import Flask, request

# Hardcoded credentials (security issue)
DB_PASSWORD = "admin123456"
API_KEY = "sk-1234567890abcdefghijklmnop"
SECRET_KEY = "very-secret-key-do-not-share"

app = Flask(__name__)

def execute_user_command(user_input):
    """
    VULNERABLE: SQL Injection & Command Injection
    User input is directly used in command execution
    """
    # This allows command injection
    result = subprocess.run(f"echo {user_input}", shell=True, capture_output=True)
    return result.stdout.decode()

def query_database(user_id):
    """
    VULNERABLE: SQL Injection
    User input is concatenated directly into SQL query
    """
    conn = sqlite3.connect(':memory:')
    cursor = conn.cursor()
    
    # Vulnerable - user input not parameterized
    query = f"SELECT * FROM users WHERE id = {user_id}"
    cursor.execute(query)
    
    return cursor.fetchall()

@app.route('/data', methods=['GET'])
def get_data():
    """
    VULNERABLE: Unsafe deserialization & Path traversal
    """
    # Unsafe pickle deserialization
    serialized_data = request.args.get('data')
    if serialized_data:
        try:
            data = pickle.loads(serialized_data.encode())
        except:
            pass
    
    # Path traversal vulnerability
    filename = request.args.get('file')
    with open(f"/var/files/{filename}", 'r') as f:
        return f.read()

@app.route('/execute', methods=['POST'])
def execute_code():
    """
    VULNERABLE: Code Injection via eval()
    """
    code = request.json.get('code')
    
    # Extremely dangerous - allows arbitrary code execution
    result = eval(code)
    
    return str(result)

def process_file(filepath):
    """
    VULNERABLE: Insecure temporary file usage
    """
    import tempfile
    
    # Predictable temp file
    temp_file = "/tmp/upload_" + os.path.basename(filepath)
    
    with open(filepath, 'rb') as src:
        with open(temp_file, 'wb') as dst:
            dst.write(src.read())
    
    return temp_file

def unsafe_network_call(url):
    """
    VULNERABLE: Insecure network communication
    """
    import urllib.request
    
    # No SSL verification
    import ssl
    ssl_context = ssl.create_default_context()
    ssl_context.check_hostname = False
    ssl_context.verify_mode = ssl.CERT_NONE
    
    response = urllib.request.urlopen(url, context=ssl_context)
    return response.read()

def weak_random_generation():
    """
    VULNERABLE: Using weak random for security-critical operations
    """
    import random
    
    # Weak random - predictable
    token = str(random.random())
    return token

def insecure_authentication(username, password):
    """
    VULNERABLE: Insecure password handling
    """
    # Password stored in plaintext
    users = {
        'admin': 'password123',
        'user': 'admin123'
    }
    
    # No rate limiting or brute force protection
    if username in users and users[username] == password:
        return True
    return False

@app.route('/upload', methods=['POST'])
def upload_file():
    """
    VULNERABLE: Arbitrary file upload
    """
    file = request.files['file']
    
    # Dangerous - saves with original filename
    # Could overwrite critical files
    file.save(f"/var/www/uploads/{file.filename}")
    
    # Even more dangerous - executes uploaded file
    if file.filename.endswith('.py'):
        exec(open(f"/var/www/uploads/{file.filename}").read())
    
    return "File uploaded"

def main():
    """Demo main function with various vulnerabilities"""
    
    # Hardcoded test data
    test_user_id = "1' OR '1'='1"
    
    # Vulnerable calls
    print("Testing vulnerable functions...")
    print(execute_user_command("rm -rf /"))  # Danger!
    print(query_database(test_user_id))
    
    # Starting vulnerable web app
    app.run(debug=True, host='0.0.0.0', port=5000)

if __name__ == '__main__':
    main()
